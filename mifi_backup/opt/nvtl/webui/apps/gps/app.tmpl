<tmpl_if isHidden>
	<div class="notification app error">
		<tmpl_var _("webui", "webui_app_hidden_text")>
	</div>
<tmpl_else>
	<tmpl_if inAirplaneMode>
		<tmpl_var _("webui", "gps_status_not_available_in_airplane_mode_error_text")>
	<tmpl_else>
		<tmpl_if haveInternet>
			<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
		</tmpl_if>

		<script type="text/javascript">
			/* <![CDATA[ */
			var map, marker, autoChange, gpsInterval, GPSEnable;
			var mapStatus = "";
			var defaultLat = 32.8954;
			var defaultLong = -117.201;
			var pollingRate = 10000;
			var isPolling = false;
			var GPSPortNumber = <tmpl_var GPSPortNumber>;

			$(function()
			{
				GPSEnable = $("#GPSEnable:checkbox");

				 <tmpl_if gpsIsOff>
				 	$(".toggleGPS").hide();
				 </tmpl_if>

				//Initialize gps values, start polling
				<tmpl_unless gpsIsOff>
					isPolling = true;
					updateGpsStatus();
					gpsInterval = window.setInterval(updateGpsStatus, pollingRate);
				</tmpl_unless>

				//Initialize map if appropriate
				<tmpl_unless gpsIsOff>
					mapInit();
				<tmpl_else>
					mapStatus = "off";
				</tmpl_unless>

				//Intialize our fancy toggle checkboxes
				if(jQuery.fn.slideButton) {
					// GPS toggle
					GPSEnable.slideButton({
						change : function($input) {
							<tmpl_if GPSEnableShow>
								if($input.is(":checked") ){
									if("<tmpl_var GPSAgreementShow>" === "1"){
										showAgreement($input);
									} else {
										postGPSEnable($input);
									}
								} else {
									postGPSEnable($input);
								}
							</tmpl_if>
						}
					});

					<tmpl_if GPSTurnOffConditionShow>
							$("#GPSTurnOffCondition").slideButton("ajaxToggle", {
								checkUrl : "<tmpl_udf GET_URI('gps_status_startupstatusoff')>",
								uncheckUrl : "<tmpl_udf GET_URI('gps_status_startupstatuson')>",
								data : {
									gSecureToken : "<tmpl_var gSecureToken>"
								}
							});
					</tmpl_if>

					<tmpl_if GPSOverWiFiEnableShow>
						<tmpl_unless GPSOverWiFiEnableLocked>
							$("#GPSOverWiFiEnable").slideButton("ajaxToggle", {
								checkUrl : "<tmpl_udf GET_URI('gps_status_gpsoverwifienable')>",
								uncheckUrl : "<tmpl_udf GET_URI('gps_status_gpsoverwifidisable')>",
								data : {
									gSecureToken : "<tmpl_var gSecureToken>"
								}
							});
						</tmpl_unless>
					</tmpl_if>					
				}

				$("#GPSPortNumber").keypress(function(event) {
					if(event.keyCode === 13) {
						$("#GPSPortNumberSave").click();
					}
				});

				$("#GPSPortNumberSave").on("click", function(){							
					$(".inline_error").html("");
					if (GPSPortNumber != $("#GPSPortNumber").val()) {
						$.post("<tmpl_udf GET_URI('gps_status_setnmeaportnumber')>", {
							GPSPortNumber : $("#GPSPortNumber").val(),
							gSecureToken : "<tmpl_var gSecureToken>"
						},
						function(data) {
							GPSPortNumber = $("#GPSPortNumber").val();
							$("#GPSPortNumberSave").prop("checked", false);
							if (jQuery.uniform)
								$.uniform.update("#GPSPortNumberSave");
						}).fail(function(data) {
							console.log("Fail");
							if ($(".inline_error").length) {
								$(".inline_error").html(data.responseJSON.GPSPortNumberError);
							} else {
								$(".input-portnum").append('<div class="col inline_error">' + data.responseJSON.GPSPortNumberError + '</div>');
							}
						});
					} else {
						$("#GPSPortNumberSave").prop("checked", false);
						if (jQuery.uniform)
							$.uniform.update("#GPSPortNumberSave");
					}					
				});

			});

		<tmpl_if GPSEnableShow>
			<tmpl_unless GPSEnableLocked>
				function showAgreement($input)
				{
					var title = '<tmpl_var _("webui", "gps_status_agreement_title")>';
					var content = "<p><tmpl_udf GET_PO_TEXT('gps_status_agreement_text1', gProductName)></p> \
						<h2><tmpl_var _('webui', 'gps_status_agreement_sub_header_text1')></h2> \
						<p><tmpl_udf GET_PO_TEXT('gps_status_agreement_text2', gProductName)></p>\
						<h2><tmpl_var _('webui', 'gps_status_agreement_sub_header_text2')></h2> \
						<p><tmpl_udf GET_PO_TEXT('gps_status_agreement_text3', gProductName)></p> \
						<h2><tmpl_var _('webui', 'gps_status_agreement_sub_header_text3')></h2> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text4')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text5')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text6')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text7')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text8')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text9')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text10')></p> \
						<p><tmpl_var _('webui', 'gps_status_agreement_text11')></p>";
					var width = 800;
					var height;
					var btns;
					var open;
					var close;

					if (typeof $input !== "undefined") {
						content = content + '<p><tmpl_var _("webui", "gps_status_agreement_action_text")></p>';

						btns = [
							{
								text: '<tmpl_var _("webui", "webui_modal_cancel_button")>',
								className: "cancel",
								trigger : function() {
									$input.slideButton("undo");
									$input.slideButton("removeLoader");
								}
							},
							{
								text:'<tmpl_var _("webui", "webui_modal_confirm_button")>',
								className:"primary",
								trigger : function() {
									postGPSEnable($input);
								}
							}
						];

						close = function() {
							$input.slideButton("undo");
							$input.slideButton("removeLoader");
						};
					}

					modalPopup.createWindow(title, content, width, height, btns, open, close);
				}
				function postGPSEnable($input)
				{
					var url = ($input.is(":checked")) ? "<tmpl_udf GET_URI('gps_status_enablegps')>" : "<tmpl_udf GET_URI('gps_status_disablegps')>";
					//prevent calling server when the server is who updated
					if (autoChange != true) {
						if (jQuery.fn.slideButton) $input.slideButton("addLoader");
						$.ajax({
							url : url,
							type : "POST",
							data : {
								gSecureToken : "<tmpl_var gSecureToken>"
							},
							dataType : "json",
							success : function(data, textStatus, xhr) {
								// If no network connected, success event still occurs.
								// We need to implicitly see an xhr.status greater than 0 to know we've actually made contact.
								if ( (xhr.readyState == 4 ) && (xhr.status == 0) ) {
									if (jQuery.fn.slideButton) $input.slideButton("undo");
								}
							},
							error : function(xhr, textStatus, errorThrown) {
								if (jQuery.fn.slideButton) $input.slideButton("undo");
								// If auth session has ended, force a new login with a fresh GET.
								if( (xhr.status == 401) || (xhr.status == 403) || (xhr.status == 406) ) window.location.replace(window.location.href);
							},
							complete : function(xhr, textStatus) {
								if(jQuery.statusBar) $.statusBar("refresh");
								if ($input.is(":checked")) {
									mapInit();
									if(isPolling === false) {
										isPolling = true;
										updateGpsStatus();
										gpsInterval = window.setInterval(updateGpsStatus, pollingRate);
									}
								} else {
									mapHide();
								}
								if (jQuery.fn.slideButton) $input.slideButton("removeLoader");
							}
						});
					} else {
						autoChange = false;
						if(jQuery.statusBar) $.statusBar("refresh");
						if ($input.is(":checked")) {
							mapInit();
						} else {
							mapHide();
						}
					}
				}
			</tmpl_unless>
		</tmpl_if>
		
		<tmpl_if GPSDownloadDriversShow>
			<tmpl_unless GPSDownloadDriversLocked>
				function showDriverDownloadDialog() {
					var title = '<tmpl_var _("webui", "gps_status_driver_download_help_title")>';
					var content = "<div id='help_wrapper'><div><h1><tmpl_var _('webui', 'gps_status_driver_download_header_text')></h1> \
						<h2><tmpl_var _('webui', 'gps_status_driver_dowload_overview_header_text')></h2> \
						<p><tmpl_var _('webui', 'gps_status_driver_download_overview_text1')><em><tmpl_var _('webui', 'gps_status_driver_download_gps_over_wifi_text')></em><tmpl_var _('webui', 'gps_status_driver_download_overview_text2')></p>\
						<p><tmpl_var _('webui', 'gps_status_driver_download_overview_text3')></p> \
						<h2><tmpl_var _('webui', 'gps_status_driver_download_available_drivers_header_text')></h2> \
						<h3><a href='<tmpl_udf GET_EXTERNAL_URI('provider_gps_windows_driver_downloader')>'><tmpl_var _('webui', 'gps_status_driver_download_for_windows_text')></a></h3> \
						<p><tmpl_var _('webui', 'gps_status_driver_download_note_for_windows_driver_text1')><em><tmpl_var _('webui', 'gps_status_driver_download_gps_over_wifi_text')></em><tmpl_var _('webui', 'gps_status_driver_download_note_for_windows_driver_text2')></p></div></div>";
					var width = 800;
					var height = 500;

					modalPopup.createWindow(title, content, width, height);
				}
			</tmpl_unless>
		</tmpl_if>

		//Updates GPS Coordinates and Status and modifies DOM/UI accordingly
		function updateGpsStatus()
		{
			$.ajax({
				url : "/gps/status/",
				type : "GET",
				dataType : "json",
				success : function(data) {
					//if gps is not off
					if (data.gpsIsOff != 1) {
						//if gps is fixed
						if (data.gpsStatus === 2 ) { //SYS_GPS_STATUS_FIX_AVAILABLE = 2
							if (mapStatus !== "fixed") {//and we're not already set to fixed
								setMapFixed();
							}
							//update ui based on gps status
							$("#gpsStatusAltitude").text(data.gpsStatusAltitude);
							if(data.gpsStatus === 1 ) {// SYS_GPS_STATUS_SEARCHING = 1
								var StatusHeadingTitle = $("<i/>").html("<tmpl_var _('webui', 'gps_status_aquiring_position_text')>").text();
								$("div#gps_panel fieldset.first h2.tableHeader").text(StatusHeadingTitle);
							} else if (data.gpsStatus === 2 ) { //SYS_GPS_STATUS_FIX_AVAILABLE = 2
								var StatusHeadingTitle = $("<i/>").html('<tmpl_var _("webui", "gps_status_current_position_label")>').text();
								$("div#gps_panel fieldset.first h2.tableHeader").text(StatusHeadingTitle);
							}
							$("#gpsStatusHorizontalVelocity").text(data.gpsStatusHorizontalVelocity);
							$("#gpsStatusLatitude").text(data.gpsStatusLatitude);
							$("#gpsStatusLongitude").text(data.gpsStatusLongitude);
							$("#gpsStatusUncertainty").text(data.gpsStatusUncertainty);
							$("#gpsStatusFixType").text(data.gpsStatusFixType);
							$("#gpsStatusTimestamp").text(data.gpsStatusTimestamp);
							$("#gpsStatusSatelliteCount").text(data.gpsStatusSatelliteCount);

							//Update our position on the map
							updateMarker(data.gpsStatusLatitude, data.gpsStatusLongitude);
						}

						//if gps is searching and we're not already set to searching
						else if (data.gpsStatus === 1 && mapStatus !== "searching") {
							setMapSearching();
						}

					//If gps is off and we're not already set to off
					} else if (data.gpsStatus === 0 && mapStatus !== "off") { //SYS_GPS_STATUS_NOT_SEARCHING = 0
						if (GPSEnable.prop("checked") === true) {
							autoChange = true;
							// Set the GPSEnable to "unchecked" and refresh the GPSEnable
							if (jQuery.fn.slideButton) GPSEnable.slideButton("toggle");
						}
						//Disable and hide Map
						setMapDisabled();
					}
				},
				error : function(xhr, textStatus, errorThrown) {
					// If auth session has ended, force a new login with a fresh GET.
					if( (xhr.status == 401) || (xhr.status == 403) || (xhr.status == 406) ) window.location.replace(window.location.href);
				}
			});
		}

		//Initialize map using default coordinates and call to update gps status.
		function mapInit()
		{
			$("#gps_panel").show();
			$(".toggleGPS").show();

			<tmpl_if haveInternet>
				// A javascript error could occur if the google object is not loaded due to a slow connection.
				if ( (typeof google === "object") && (typeof google.maps === "object") ) {
					var defaultLatLng = new google.maps.LatLng(defaultLat, defaultLong);
					var myOptions = {
						zoom : 2,
						center : defaultLatLng,
						mapTypeId : google.maps.MapTypeId.ROADMAP
					};

					map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
				} else {
					map = null; // google object is not loaded
					$("#map_canvas").hide();
				}
			<tmpl_else>
				map = null; // internet is not available
				$("#map_canvas").hide();
			</tmpl_if>

			$("#map_status").html('<tmpl_var _("webui", "gps_status_searching_text")>').removeClass("fixed").addClass("loading");
			mapStatus = "searching";

			<tmpl_unless MapWhileSearchingShow>
				$("#map_canvas").hide();
			</tmpl_unless>
		}

		//Update map marker and center map based on latitude and longitude
		function updateMarker(latitude, longitude)
		{
			<tmpl_if haveInternet>
				// A javascript error could occur if the google object is not loaded due to a slow connection.
				if ( (typeof google === "object") && (typeof google.maps === "object") ) {
					//Update map with new coordinates or create a new one if undefined
					var newLatLng = new google.maps.LatLng(latitude, longitude);
					if (map != undefined && map != null) {
						if (marker != undefined && marker != null) {
							marker.setPosition(newLatLng);
						} else {
							marker = new google.maps.Marker({
								position : newLatLng,
								map : map,
								draggable : true
							});
							map.setZoom(16);
						}
						map.panTo(newLatLng);
					}
				} else {
					marker = null; // google object is not loaded
				}
			<tmpl_else>
				marker = null; // internet is not available
			</tmpl_if>
		}

		//Set DOM Elements to searching styles and remove marker from map.
		function setMapSearching()
		{
			$("#gps_table").hide();
			$("#map_status").html('<tmpl_var _("webui", "gps_status_searching_text")>').removeClass("fixed").addClass("loading");
			mapStatus = "searching";

			<tmpl_if haveInternet>
			if (marker != undefined && marker != null) {
				marker.setMap(null);
			}
			</tmpl_if>
		}

		//Set DOM Elements to fixed styles
		function setMapFixed()
		{
			$("#gps_table").show();
			$("#map_status").html('<tmpl_var _("webui", "gps_status_acquired_text")>').removeClass("loading").addClass("fixed");
			mapStatus = "fixed";

			<tmpl_if haveInternet>
			$("#map_canvas").show();
			if (marker != undefined && marker != null) {
				marker.setMap(map);
			}
			</tmpl_if>
		}

		//Set DOM Elements to disabled styles
		function setMapDisabled()
		{
			clearInterval(gpsInterval);
		}

		//Hide Map and reset map and marker
		function mapHide()
		{
			mapStatus = "off";
			$("#map_status").html("");
			$(".toggleGPS").hide();
			marker = null;
			map = null;
		}

		/* ]]> */
		</script>

		<tmpl_if isLocked>
				<div class="notification app error">
			<tmpl_var _("webui", "webui_app_locked_text")>
				</div>
		</tmpl_if>

		<tmpl_if errorCount>
		<div class="notification app error">
			<div class="notification_inner">
				<p>
					<tmpl_var _("webui", "webui_save_code_failed_text")>
				</p>
			</div>
		</div>
		</tmpl_if>

		<tmpl_if gPostSuccess>
		<div class="notification app success">
			<div class="notification_inner">
				<p>
					<tmpl_var _("webui", "webui_save_code_success_text")>
				</p>
			</div>
		</div>
		</tmpl_if>

		<p class="note">
			<tmpl_var _("webui", "gps_status_intro_label")>
		</p>

		<div class="table">
			<div class="row clearfix">
				<p>
					<tmpl_var _("webui", "gps_status_enable_help_text")>
				</p>
			</div>
		
			<div id="gps_panel">
				<div class="row clearfix">
					<div class="col-primary">
						<tmpl_if GPSEnableShow>
							<div class="row clearfix">					
								<div class="toggleSettingContainer">
									<div class="toggleSettingContainerInner">
										<div class="desc">
											<h4><label for="GPSEnable"><tmpl_var _("webui", "gps_status_enable_label")></label></h4>
										</div>
										<div class="toggle">
											<input class="toggleSwitchCheckbox" type="checkbox" id="GPSEnable" name="GPSEnable"<tmpl_unless gpsIsOff> checked="checked"</tmpl_unless> <tmpl_if GPSEnableLocked> disabled="disabled" </tmpl_if> <tmpl_if isLocked>disabled="disabled"</tmpl_if> />
										</div>
									</div><!--/.toggleSettingContainerInner-->
								</div><!--/.toggleSettingContainer-->
							</div>
						</tmpl_if>
						<tmpl_if GPSTurnOffConditionShow>
							<div class="row clearfix toggleGPS">					
								<fieldset class="first">
									<div class="toggleSettingContainer">
										<div class="toggleSettingContainerInner">
											<div class="desc">
												<h4><label for="GPSTurnOffCondition"><tmpl_udf GET_PO_TEXT("gps_status_startup_state_label", gProductName)></label></h4>
											</div>
											<div class="toggle">
												<input class="toggleSwitchChcekbox" type="checkbox" id="GPSTurnOffCondition" name="GPSTurnOffCondition" <tmpl_if IN_SET(gpsStartupState, 0, "0")> checked="checked"</tmpl_if><tmpl_if GPSTurnOffConditionLocked> disabled="disabled" </tmpl_if> />
											</div>
										</div><!--/.toggleSettingContainerInner-->
									</div><!--/.toggleSettingContainer-->
								</fieldset>
							</div>
						</tmpl_if>
						<br>
						<div class="row clearfix toggleGPS">
							<tmpl_if GPSCurrentLocationShow>
								<h3 class="sectionHead">
									<tmpl_var _("webui", "gps_status_current_location_label")>
								</h3>
							</tmpl_if>

							<fieldset>
								<div class="row clearfix">
									<div class="col textCol" id="map_status"><tmpl_var _("webui", "gps_status_searching_text")></div>
								</div>
								<div id="gps_table" class="table clearfix" <tmpl_if gpsIsOff>style="display:none;"</tmpl_if> <tmpl_if IN_SET(gpsStatus, 1)>style="display:none;"</tmpl_if>>
									<br>
									<div class="row clearfix">
										<div class="col label"><tmpl_var _("webui", "gps_status_latitude_label")></div>
										<div class="col textCol" id="gpsStatusLatitude"><tmpl_var gpsStatusLatitude></div>
									</div><!-- /.row -->
									<div class="row clearfix">
										<div class="col label"><tmpl_var _("webui", "gps_status_altitude_label")></div>
										<div class="col textCol" id="gpsStatusAltitude"><tmpl_var gpsStatusAltitude></div>
									</div><!-- /.row -->
									<div class="row clearfix">
										<div class="col label"><tmpl_var _("webui", "gps_status_longitude_label")></div>
										<div class="col textCol" id="gpsStatusLongitude"><tmpl_var gpsStatusLongitude></div>
									</div><!-- /.row -->
									<div class="row clearfix">
										<div class="col label"><tmpl_var _("webui", "gps_status_accuracy_label")></div>
										<div class="col textCol" id="gpsStatusUncertainty"><tmpl_var gpsStatusUncertainty></div>
									</div><!-- /.row -->							
								</div><!-- /.table -->
							</fieldset>
						</div>
					</div>
					<div class="col-secondary bg-color toggleGPS">
						<tmpl_if GPSOverWiFiSettingsShow>
							<div class="row clearfix">
								<fieldset>
									<tmpl_if GPSOverWiFiEnableShow>
										<div class="row clearfix">

											<div class="toggleSettingContainer">
												<div class="toggleSettingContainerInner">
													<div class="desc">
														<div class="tooltip tooltip-help" title="<tmpl_var _('webui', 'gps_status_gps_over_wifi_help_text')>">
															<tmpl_var _("webui", "webui_inline_help_icon")>
														</div>															
														<label for="GPSOverWiFiEnable">
															<tmpl_var _("webui", "gps_status_gps_over_wifi_label")>
														</label>															
													</div>

													<div class="toggle">
														<input class="toggleSwitchCheckbox" type="checkbox" id="GPSOverWiFiEnable" name="GPSOverWiFiEnable"  <tmpl_if GPSOverWiFiEnable> checked="checked"</tmpl_if><tmpl_if GPSOverWiFiEnableLocked> disabled="disabled"</tmpl_if> <tmpl_if isLocked>disabled="disabled"</tmpl_if> />
													</div>
												</div><!--/.toggleSettingContainerInner-->
											</div><!--/.toggleSettingContainer-->
											
										</div>
									</tmpl_if>

									<tmpl_if GPSPortNumberShow>
										<div class="row clearfix">
											<div class="col label-teeny">
												<label for="GPSPortNumber">
													<tmpl_var _("webui", "gps_status_port_number_label")>
												</label>
											</div>
											<div class="col input-portnum">
												<input type="text" size="5" name="GPSPortNumber" id="GPSPortNumber" maxlength="5" value="<tmpl_var GPSPortNumber>"<tmpl_if GPSPortNumberLocked> disabled="disabled"</tmpl_if><tmpl_if GPSPortNumberError> class="error"</tmpl_if> />
												<input type="checkbox" name="GPSPortNumberSave" id="GPSPortNumberSave" <tmpl_if isLocked>disabled="disabled"</tmpl_if>/>
											</div>

										</div>
									</tmpl_if>

									<tmpl_if GPSOverWiFiEnableShow>
										<div class="row clearfix">
											<p><tmpl_udf GET_PO_TEXT("gps_status_port_number_help_text", gProductName)></p>
											<p><tmpl_udf GET_PO_TEXT("gps_status_gps_over_wifi_text", gProductName)></p>
										</div>
									</tmpl_if>
								</fieldset>

								<tmpl_if GPSDownloadDriversShow>
									<div class="row clearfix">
										<fieldset id="downloadGpsOverDriver">
											<div class="button_container clearfix">
												<a class="goUrl" id="downloadGpsDriver" <tmpl_if downloadGpsDriverLocked> disabled" <tmpl_else>" onclick="showDriverDownloadDialog();"</tmpl_if>>
		                                            <tmpl_var _("webui", "gps_status_wifi_driver_download_link")>
		                                        </a>
											</div>
										</fieldset>
									</div>
								</tmpl_if>
							</div>
						</tmpl_if>
					</div>
				</div>
				<br>
				<div class="row clearfix toggleGPS">
					<div id="map_canvas"></div>
				</div>
			</div>

		</div>	<!-- .table -->
	</tmpl_if><!-- /inAirplaneMode -->
</tmpl_if><!-- isHidden -->
