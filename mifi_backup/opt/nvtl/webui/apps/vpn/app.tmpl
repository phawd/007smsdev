<tmpl_if isHidden>
	<div class="notification app error">
		<tmpl_var _("webui", "webui_app_hidden_text")>
	</div>
<tmpl_else>
<script type="text/javascript">
	/* <![CDATA[ */

var pollingRate = 2000; // 2 secs
var files;
var connState;
$(function()
{
	makeDroppable();

	if('<tmpl_var !dropBoxEnable>') {
		$(".droppable").find("#filesList").prop("disabled","disabled");
		$(".droppable").addClass("disabled");
	}

	getVpnConnectionStats();

    //Intializing toggle checkboxes
	if(jQuery.fn.slideButton) {
		// VPN toggle button
		$("#autoConnectEnabled").slideButton({
			change : function($input) {
				AutoVPNToggled($input.is(":checked"), $input);
			}
		});
	}

	<tmpl_unless isLocked>
	$("#viewLog").on("click", function() {
		getVpnLog();
	});
	</tmpl_unless>

	<tmpl_unless isLocked>
	$("#vpnConnectDisconnect").on("click", function() {
		var url = ($.trim($(this).text()) == '<tmpl_var _("webui", "vpn_connect_button_text")>') ? "<tmpl_udf GET_URI('vpn_connect')>" : "<tmpl_udf GET_URI('vpn_disconnect')>";

		if($.trim($(this).text()) == '<tmpl_var _("webui", "vpn_disconnect_button_text")>'){
			$("#vpnConnectDisconnect").prop( "disabled", 1);
		}

		$.ajax({
			url : url,
			type : "POST",
			data : {
				gSecureToken : "<tmpl_var gSecureToken>"
			},
			dataType : "json",
			success : function(data, textStatus, xhr) {
				getVpnConnectionStats();
			}
		});
	});
	</tmpl_unless>

	<tmpl_unless isLocked>
	$("#clearAllVpnSettings").on("click", function() {
		modalPopup.createWindow('<tmpl_var _("webui", "webui_modal_title_confirm_text")>', '<tmpl_var _("webui", "vpn_clear_all_settings_popup_text")>', 430, "auto", [{
            text : '<tmpl_var _("webui", "webui_modal_confirm_button")>',
            className : "primary",
            trigger: function() {
                $.ajax({
					url : "<tmpl_udf GET_URI('clear_vpn_settings')>",
					type : "POST",
					data : {
						gSecureToken : "<tmpl_var gSecureToken>"
					},
					dataType : "json",
					success : function(data) {
						console.log("clear_vpn_settings is success");
						$(".inline_error, .app.error").html(""); 
						window.location = "<tmpl_udf GET_URI('vpn')>";
					},
					error : function(xhr, textStatus, errorThrown) {
						console.log("clear_vpn_settings is failed");
					}
				});                
            }
        }, {
            text : '<tmpl_var _("webui", "webui_modal_cancel_button")>',
            className : "cancel",
        }]);
		
	});
	</tmpl_unless>
});

function getVpnLog()
{
	$.ajax({
		url : '<tmpl_udf GET_URI("vpn_logs")>',
		type : "GET",
		dataType : "json",
		success : function(data){
			buildTableFromArray(data["vpnLogsDisplay"]);
		},
		error : function(xhr, textStatus, errorThrown) {
			// If auth session has ended, force a new login with a fresh GET.
			if( (xhr.status == 401) || (xhr.status == 403) || (xhr.status == 406) ) window.location.replace(window.location.href);
		}
	});
}

// Builds log table from data. Expects data to be a "\n" delimited string.
function buildTableFromArray(data)
{
	var table = $('<table class="logs" />');
	var tbody = $('<tbody />');
	if(data == "" || typeof data == "undefined"){
		tbody = $('<tbody><tr><td id="noLogData"><tmpl_var _("status_logs_text_no_data")></td></tr></tbody>');
	} else {
		var rows = "";
		var splitData = data.split("\n");

		$.each(splitData, function(i) {
			var zebra = (i % 2) ? "odd" : "even";
			rows += '<tr class="' + zebra + '"><td>' + splitData[i] + '</td></tr>';
		});

		$(rows).appendTo(tbody);
	}

	table.append(tbody);

	var title = '<tmpl_var _("webui", "vpn_view_log_title_text")>';
	modalPopup.createWindow(
			title,
			table,
			900, 700
		);
}

function getVpnConnectionStats()
{
    $.ajax({
        url : '<tmpl_udf GET_URI("vpn_status")>',
        type : "GET",
        dataType : "json",
        success : function(data) {
            if (data) {
            	connState = data.connectionState;
            	if(data.connectionState == "<tmpl_var _('webui', 'vpn_checking_vpn_connection')>") {
            		$("#UpdateStatusIndicator").show();
            		$("#connectionState").hide();
            	} else {
            		$("#connectionState").html(data.connectionState);
            		$("#connectionState").show();
            		$("#UpdateStatusIndicator").hide();
            	}
                $("#vpnConnectDisconnect").html(data.connectDisconnectButtonText);
                $("#vpnConnectDisconnect").prop( "disabled", !data.showConnectButton );
            	if(data.isAutoConnectEnabled) {
            		if (jQuery.fn.slideButton) {
	            		$("#autoConnectEnabled").slideButton("disable", false);
	            	}
            	}
                $( "#viewLog" ).prop( "disabled", !data.showLogButton );
                if(data.connectionState == "<tmpl_var _('webui', 'vpn_connected_text')>") {
                	$("#vpnConnectionTime").show().html(data.connectedDays + "<tmpl_var _('webui', 'vpn_connection_days_text')>"+ data.connectedHours+"<tmpl_var _('webui', 'vpn_connection_hours_text')>" +data.connectedMinutes +"<tmpl_var _('webui', 'vpn_connection_minutes_text')>" + data.connectedSeconds+ "<tmpl_var _('webui', 'vpn_connection_seconds_text')>");
                } else {
                	$("#vpnConnectionTime").html(" ");
                }
            }
        },
        error : function(xhr, textStatus, errorThrown) {

        },
        complete : function() {
            	setTimeout(getVpnConnectionStats, pollingRate);
        }
    });
}

function AutoVPNToggled(bool, $toggleSwitchElement)
{
	if(jQuery.fn.slideButton) $toggleSwitchElement.slideButton("addLoader");
	var url = (bool) ? "<tmpl_udf GET_URI('vpn_auto_connect_enable')>" : "<tmpl_udf GET_URI('vpn_auto_connect_disable')>";
	$.ajax({
		url : url,
		type : "POST",
		data : {
			gSecureToken : "<tmpl_var gSecureToken>"
		},
		dataType : "json",
		success : function(data, textStatus, xhr) {
			// If no network connected, success event still occurs.
			// We need to implicitly see an xhr.status greater than 0 to know we've actually made contact.
			if ( (xhr.readyState == 4 ) && (xhr.status == 0) ) {
				undoChange($toggleSwitchElement);
			}
		},
		error : function(xhr, textStatus, errorThrown) {
			undoChange($toggleSwitchElement);
			// If auth session has ended, force a new login with a fresh GET.
			if( (xhr.status == 401) || (xhr.status == 403) || (xhr.status == 406) ) window.location.replace(window.location.href);
		},
		complete : function(xhr, textStatus) {
			if(jQuery.fn.slideButton) $toggleSwitchElement.slideButton("removeLoader");
		}
	});
}

function collectFiles(e) {
	console.log("triggerCallback");
	var files_list;
	var display_files_list;
	if(e.originalEvent && e.originalEvent.dataTransfer) {
		files = e.originalEvent.dataTransfer.files;
		document.getElementById("filesList").files = e.originalEvent.dataTransfer.files;
	} else if(e.target) {
		files = e.target.files;
	}
	for(var i=0; i<files.length; i++) {
    	if(i == 0) {
    		files_list = files[i].name;
    		display_files_list = files[i].name;
    	} else {
    		files_list = files_list + "," + files[i].name;
    		display_files_list = display_files_list + "<br>" + files[i].name;
    	}
    	
    }
    if(files.length > 0) {
		$("#fileNames").val(files_list);
		$("#filesSelectedValue").html(display_files_list);
		console.log("total_files_list : ", $("#filesSelected").val());
		$("#filesSelectedSection").show();
    }
}

function makeDroppable() {
	var ele = $(".droppable");
	console.log("makeDroppabl");
	var input = document.createElement('input');
    input.setAttribute('name', 'filesList');
    input.setAttribute('id', 'filesList');
    input.setAttribute('type', 'file');
    input.setAttribute('multiple', true);
    input.style.display = 'none';

    input.addEventListener('change', function(e) {
    	console.log("change");
    	collectFiles(e);
    });

    $(ele).append(input);
      
    ele.on('dragover', function(e) {
      	console.log("dragover");
        e.preventDefault();
        e.stopPropagation();
        e.originalEvent.dataTransfer.dropEffect = 'copy';
        ele.addClass('dragover');
    });

    ele.on('dragleave', function(e) {
      	console.log("dragleave");
        e.preventDefault();
        e.stopPropagation();
        ele.removeClass('dragover');
    });

    ele.on('drop', function(e) {
      	console.log("drop");
        e.preventDefault();
        e.stopPropagation();
        ele.removeClass('dragover');
        collectFiles(e);
    });
      
    ele.on('click', function() {
    	console.log("click");
        input.value = null;
        input.click();
    });
}

	/* ]]> */
</script>

	<tmpl_if errorCount>
		<div class="notification app error">
			<div class="notification_inner">
				<p>
					<tmpl_var _("webui", "webui_save_code_failed_text")>
				</p>
			</div>
		</div>
	</tmpl_if>

	<tmpl_if gPostSuccess>
		<div class="notification app success">
			<div class="notification_inner">
				<p>
					<tmpl_var _("webui", "webui_save_code_success_text")>
				</p>
			</div>
		</div>
	</tmpl_if>


	<tmpl_if isLocked>
		<div class="notification app error">
			<tmpl_var _("webui", "webui_app_locked_text")>
		</div>
	</tmpl_if>

	<p><tmpl_var _("webui", "vpn_note_text")></p>

	<div class="toggleSettingContainer scrimp">
		<div class="toggleSettingContainerInner">
			<div class="desc">		<!-- Integrate ToolTip -->
				<div class="col tooltip tooltip-help" title="<tmpl_var _('webui', 'vpn_auto_connect_help_text')>">
					<tmpl_var _("webui", "webui_inline_help_icon")>
				</div>
				<h4><label for="autoConnectEnabled"><tmpl_var _("webui", "vpn_auto_connect_label")></label></h4>
			</div>		
			<div class="toggle">
				<input class="toggleSwitchCheckbox" type="checkbox" id="autoConnectEnabled" name="autoConnectEnabled" <tmpl_if IN_SET(autoConnectEnabled, "true", "on", "1")> checked="checked"</tmpl_if><tmpl_unless isAutoConnectEnabled> disabled="disabled"</tmpl_unless> <tmpl_if isLocked>disabled="disabled"</tmpl_if>/>
			</div>
		</div><!--/.toggleSettingContainerInner-->
	</div><!--/.toggleSettingContainer-->

	<div class="row clearfix">
		<h2 class="sectionHead"><tmpl_var _("webui", "vpn_connection_sub_head_text")></h2>
	</div>

	<div class="row clearfix">
		<div class="col label">
			<h4><label><tmpl_var _("webui", "vpn_connection_status_label")></label></h4>
		</div>
		<div class="col textCol" id="connectionState">
			<tmpl_var connectionState>
		</div>
		<div id="UpdateStatusIndicator" style="display:none;">
            <div class="row">
            	<div class="col loading"></div>
            	<p><tmpl_var _("webui", "vpn_checking_vpn_connection")></p>
            </div>
	    </div>
	</div>

	<div class="row clearfix">
		<div class="col label"> &nbsp;</div>
		<div class="col textCol" id="vpnControl">
			<button type="button" id="vpnConnectDisconnect" class="primary" <tmpl_unless showConnectButton> disabled="disabled"</tmpl_unless> <tmpl_if isLocked>disabled="disabled"</tmpl_if>>
				<tmpl_var connectDisconnectButtonText>
			</button>
			<button type="button" id="viewLog" class="primary" <tmpl_unless showLogButton> disabled="disabled"</tmpl_unless> <tmpl_if isLocked>disabled="disabled"</tmpl_if>>
				<tmpl_var _("webui", "vpn_view_log_button_text")>
			</button>
		</div>
	</div>

	<div class="row clearfix">
		<div class="col label">
			<h4><label><tmpl_var _("webui", "vpn_connection_time_label")></label></h4>
		</div>
		<div class="col textCol" id="vpnConnectionTime" <tmpl_unless isVPNConnected>style="display:none"</tmpl_unless>>
			<tmpl_udf GET_PO_TEXT('vpn_connection_time_text', connectedDays, connectedHours, connectedMinutes, connectedSeconds)>
		</div>
	</div>

	<div class="row clearfix">
		<h3 class="sectionHead"><tmpl_var _("webui", "vpn_settings_sub_head_text")></h3>
	</div>

	<form method="POST" action="<tmpl_udf GET_URI('vpn')>" id="vpnForm" enctype="multipart/form-data">
		<input type="hidden" id="gSecureToken" name="gSecureToken" value="<tmpl_var gSecureToken>" />
		<input type="hidden" id="fileNames" name="fileNames" value="" /><div class="row clearfix">

		<div class="row clearfix">
			<div class="col label">
				<h4><label><tmpl_var _("webui", "vpn_setup_files_label")></label></h4>
			</div>
			<div class="col input droppable">
				<tmpl_var dropBoxInlineText>
				<div class="row clearfix" id="filesSelectedSection" style="display:none;">
				<div class="col input" id="filesSelectedValue">
						<tmpl_var filesSelectedValue>
		 		</div>
				</div>
			</div>
		</div>
		<div class="row clearfix">
			<tmpl_if vpnFileValidationError>
				<div class="col inline_error">
					<tmpl_var vpnFileValidationError>
				</div>
				<div class="col inline_error">
					<tmpl_var vpnFileValidationName>
				</div>
			</tmpl_if>
		</div>

		<div class="row clearfix">
			<div class="col label">
				<h4><label><tmpl_var _("webui", "vpn_username_label")></label></h4>
			</div>
			<div class="col input">
				<input type="text" name="vpnUserName" id="vpnUserName" class="uniform-input text" value="<tmpl_var vpnUserName>" <tmpl_if vpnUserNameError>class="error"</tmpl_if> />
			</div>
			<tmpl_if vpnUserNameError>
				<div class="col inline_error">
					<tmpl_var vpnUserNameError>
				</div>
			</tmpl_if>
		</div>

		<div class="row clearfix">
			<div class="col label">
				<h4><label><tmpl_var _("webui", "vpn_password_label")></label></h4>
			</div>
			<div class="col input">
				<input type="password" name="vpnPassword" id="vpnPassword" class="uniform-input text" value="<tmpl_var vpnPassword>" <tmpl_if vpnPasswordError>class="error"</tmpl_if> />
			</div>
			<tmpl_if vpnPasswordError>
				<div class="col inline_error">
					<tmpl_var vpnPasswordError>
				</div>
			</tmpl_if>
		</div>

		<div class="button_container clearfix" id="vpnSettingsClear">
		    <button type="button" class="secondary" id="clearAllVpnSettings" <tmpl_if isLocked> disabled="disabled"</tmpl_if>>
		        <tmpl_var _("webui", "vpn_clear_all_settings_button_text")>
		    </button>
		</div>

		<div class="button_container clearfix" id="saveVpnSettings">
		    <button type="submit" class="primary" <tmpl_if isLocked> disabled="disabled"</tmpl_if>>
		        <tmpl_var _("webui", "webui_save_button")>
		    </button>
		</div>
	</form>
</tmpl_if> <!-- isHidden -->